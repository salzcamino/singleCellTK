# singleCellTK - Claude Code Guide

## Project Overview

The Single Cell Toolkit (SCTK) is a comprehensive Bioconductor R package for single-cell RNA-sequencing (scRNAseq) data analysis. It provides both a command-line interface and an interactive Shiny GUI for preprocessing, quality control, analysis, and visualization of single-cell RNA-seq data.

**Package Name:** singleCellTK
**Version:** 2.18.0
**License:** MIT + file LICENSE
**Website:** https://www.camplab.net/sctk/
**Repository:** https://github.com/compbiomed/singleCellTK

## Key Features

- Interactive Shiny GUI for users without programming experience
- Console-based analysis using R wrapper functions
- Comprehensive HTML reports via RMarkdown
- Integration of tools from both R (Seurat, Bioconductor) and Python (Scanpy)
- Support for multiple data import formats (10x CellRanger, BUStools, Optimus, STARSolo)
- Quality control including doublet detection and ambient RNA removal
- Curated workflows for Seurat, Scanpy, and Celda

## Project Structure

```
singleCellTK/
├── R/                  # R source code (100+ function files)
├── man/                # Documentation files (generated by roxygen2)
├── vignettes/          # Long-form documentation and tutorials
├── tests/              # Unit tests (testthat)
├── inst/               # Installed files (Shiny app, templates, etc.)
├── exec/               # Executable scripts
├── data/               # Package data
├── data-raw/           # Raw data and data generation scripts
├── docs/               # pkgdown website files
├── .github/            # GitHub Actions workflows
├── DESCRIPTION         # Package metadata and dependencies
├── NAMESPACE           # Package exports (auto-generated)
├── README.md           # Main project documentation
├── NEWS.md             # Changelog
└── _pkgdown.yml        # pkgdown website configuration
```

## Key Directories

### R/
Contains all R function definitions. Key areas include:
- Data import functions (e.g., `importCellRanger`, `importAnnData`)
- QC functions (e.g., `detectCellOutlier`, doublet detection)
- Analysis workflows (Seurat, Scanpy, Celda integration)
- Visualization functions (heatmaps, plots)
- Shiny UI/server components

### inst/
- `inst/shiny/` - Shiny application code
- `inst/rmarkdown/` - Report templates
- `inst/scripts/` - Pipeline scripts

### vignettes/
- Tutorial vignettes showing various workflows
- Import/QC, a la carte workflow, curated workflows
- Build with: `devtools::build_vignettes()`

### tests/
- Unit tests using testthat framework
- Run with: `devtools::test()` or `R CMD check`

## Development Workflow

### Setup
```r
# Install package dependencies
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install()

# Install development tools
install.packages(c("devtools", "roxygen2", "testthat", "BiocCheck"))

# Load package for development
devtools::load_all()
```

### Common Commands

```r
# Document package (update NAMESPACE and .Rd files)
devtools::document()

# Check package
devtools::check()

# Run Bioconductor-specific checks
BiocCheck::BiocCheck(".")

# Run tests
devtools::test()

# Build package
devtools::build()

# Install locally
devtools::install()

# Run Shiny app
singleCellTK()
```

### Testing

- Tests are located in `tests/testthat/`
- Run all tests: `devtools::test()`
- Run specific test file: `testthat::test_file("tests/testthat/test-filename.R")`
- Coverage: Package uses codecov for coverage tracking

### Documentation

- Use roxygen2 for function documentation
- Each function should have `@title`, `@description`, `@param`, `@return`, `@examples`, `@export`
- After editing roxygen comments, run `devtools::document()`
- Build website: `pkgdown::build_site()`

## Important Files

- **DESCRIPTION**: Package metadata, dependencies, and version
- **NAMESPACE**: Export/import declarations (auto-generated by roxygen2)
- **NEWS.md**: Version changelog
- **README.md**: Project overview and quick start
- **_pkgdown.yml**: Website configuration

## Architecture Notes

### Data Structure
- Primary data object: `SingleCellExperiment` (SCE) from Bioconductor
- Also supports Seurat objects and AnnData (Python)
- Conversion functions available for interoperability

### Key Dependencies
- **Core Bioconductor**: SingleCellExperiment, SummarizedExperiment, scater, scran
- **Analysis**: Seurat, celda, MAST, limma
- **QC**: DropletUtils, scds, scDblFinder, SoupX
- **Visualization**: ggplot2, plotly, ComplexHeatmap
- **GUI**: shiny, shinyjs, DT
- **Python integration**: reticulate (for Scanpy integration)

### Shiny Application
- Entry point: `singleCellTK()` function
- UI/Server code in `R/` directory (files prefixed with `ui_` or `server_`)
- Modular design with separate tabs for different analyses

## Bioconductor Guidelines

This package follows Bioconductor coding standards:
- Use `<-` for assignment (not `=`)
- Indent with 4 spaces
- Line length limit: 80 characters
- Use camelCase for function names
- Include comprehensive examples and vignettes
- Pass `BiocCheck::BiocCheck()`

## CI/CD

GitHub Actions workflows (`.github/workflows/`):
- **BioC-check.yaml**: Bioconductor compatibility check
- **R-CMD-check.yaml**: Standard R package check
- Both run on push/PR to master branch

## Python Integration

SCTK integrates Python tools (like Scanpy) via reticulate:
- Python dependencies managed separately
- Conda environment recommended for Python packages
- See installation vignette for Python setup details

## Useful Tips

1. **Working with SCE objects**: Most functions expect a `SingleCellExperiment` object. Use `colData()`, `rowData()`, and `assay()` to access metadata and expression data.

2. **Adding new functions**:
   - Add R code to `R/` directory
   - Document with roxygen2 comments
   - Add to NAMESPACE via `@export`
   - Add tests in `tests/testthat/`
   - Update NEWS.md

3. **Debugging Shiny**: Use `options(shiny.reactlog=TRUE)` and Cmd/Ctrl+F3 in browser to see reactive graph

4. **Large datasets**: Package uses DelayedArray for memory-efficient operations

5. **Version management**: Follow Bioconductor versioning (x.y.z where y is even for release, odd for devel)

## Common Issues

- **Dependency conflicts**: This package has many dependencies. Use `renv.lock` for reproducible environments
- **Python integration**: Ensure reticulate is configured correctly and Python packages are installed
- **Memory**: Single-cell datasets can be large. Consider using HDF5-backed data structures

## Resources

- **Documentation**: https://camplab.net/sctk/
- **Bioconductor page**: https://bioconductor.org/packages/singleCellTK
- **Issues**: https://github.com/compbiomed/singleCellTK/issues
- **Discussions**: https://github.com/compbiomed/singleCellTK/discussions

## Citations

If using this package, please cite:
- Hong et al., Nature Communications, 2022 (for QC)
- Wang et al., Patterns, 2023 (for analysis workflows)
